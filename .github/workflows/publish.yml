name: Process Uploads & Build Site

on:
  push:
    branches:
      - main
    paths:
      - 'upload/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force a complete rebuild of the site'
        required: false
        default: true
        type: boolean

jobs:
  process-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Process Images in Upload Directory
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # Check if upload directory is empty
        if [ -z "$(ls -A upload)" ]; then
           echo "Upload directory is empty, skipping processing."
           # If triggered by push to upload/, we expect files. 
           # If manually triggered, maybe we just want to rebuild.
           if [ "${{ github.event_name }}" == "push" ]; then
               exit 0 
           fi
        fi

        # Iterate over files in upload directory (if any)
        if [ -n "$(ls -A upload 2>/dev/null)" ]; then
            for image_file in upload/*; do
                if [ -f "$image_file" ]; then
                    echo "Processing $image_file..."
                    python publish.py "$image_file"
                    
                    # Remove the file after successful processing
                    if [ $? -eq 0 ]; then
                        rm "$image_file"
                        echo "Removed $image_file"
                    else
                        echo "Failed to process $image_file"
                        exit 1
                    fi
                fi
            done
        else
            echo "No files in upload directory."
        fi

    - name: Build Site
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_rebuild }}" == "true" ]; then
          python build.py --force
        else
          python build.py
        fi

    - name: Commit and Push Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto-publish: Processed uploaded images [skip ci]"
            git push
        else
            echo "No changes to commit."
        fi
